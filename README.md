# üè¢ Plugin SCI - Recherche et Contact de Soci√©t√©s Civiles Immobili√®res

Un plugin WordPress complet pour rechercher, g√©rer et contacter des SCI (Soci√©t√©s Civiles Immobili√®res) via les APIs officielles INPI et La Poste.

## üìã Table des mati√®res

- [Fonctionnalit√©s](#-fonctionnalit√©s)
- [Pr√©requis](#-pr√©requis)
- [Installation](#-installation)
- [Configuration](#-configuration)
- [Utilisation](#-utilisation)
- [Shortcodes](#-shortcodes)
- [APIs utilis√©es](#-apis-utilis√©es)
- [Structure du plugin](#-structure-du-plugin)
- [Changelog](#-changelog)
- [Support](#-support)

## üöÄ Fonctionnalit√©s

### üîç **Recherche de SCI**
- Recherche par code postal via l'API INPI
- Affichage des informations compl√®tes (d√©nomination, dirigeant, SIREN, adresse)
- Liens Google Maps int√©gr√©s pour localiser les adresses
- Statut de contact pour √©viter les doublons

### ‚≠ê **Gestion des favoris**
- Syst√®me de favoris avec stockage en base de donn√©es
- Synchronisation automatique entre localStorage et BDD
- Page d√©di√©e pour g√©rer ses favoris

### üì¨ **Campagnes de lettres**
- Cr√©ation de campagnes personnalis√©es
- G√©n√©ration automatique de PDFs
- Envoi via l'API La Poste (LRAR, LR, etc.)
- Suivi complet des envois avec UID de tracking

### üí≥ **Syst√®me de paiement**
- Int√©gration WooCommerce pour le paiement s√©curis√©
- Checkout embarqu√© dans un popup
- Traitement automatique apr√®s paiement confirm√©
- Fallback vers envoi direct si WooCommerce indisponible

### üîê **S√©curit√© et configuration**
- Gestion automatique des tokens INPI
- Configuration s√©curis√©e des APIs
- Stockage chiffr√© des identifiants
- Interface d'administration compl√®te

## üìã Pr√©requis

### **Obligatoires**
- WordPress 5.0+
- PHP 7.4+
- MySQL 5.7+

### **Recommand√©s**
- WooCommerce 6.0+ (pour le syst√®me de paiement)
- Advanced Custom Fields (ACF) (pour les champs utilisateur √©tendus)
- SSL activ√© (pour les APIs externes)

### **APIs requises**
- **Compte INPI** avec acc√®s API
- **Compte La Poste** avec cl√© API pour l'envoi de lettres

## üõ† Installation

### **1. Installation du plugin**
```bash
# Via l'admin WordPress
1. T√©l√©charger le fichier ZIP du plugin
2. Aller dans Extensions > Ajouter
3. T√©l√©verser le fichier ZIP
4. Activer le plugin

# Via FTP
1. Extraire le dossier dans /wp-content/plugins/
2. Activer depuis l'admin WordPress
```

### **2. Configuration des APIs**
1. Aller dans **SCI > Configuration**
2. Renseigner vos tokens API INPI et La Poste
3. Configurer les param√®tres d'envoi La Poste
4. Tester la connexion

### **3. Configuration des identifiants INPI**
1. Aller dans **SCI > Identifiants INPI**
2. Saisir vos identifiants de connexion INPI
3. Le token sera g√©n√©r√© automatiquement

## ‚öôÔ∏è Configuration

### **üîë APIs et tokens**

#### **INPI (Institut National de la Propri√©t√© Industrielle)**
- **URL API** : `https://registre-national-entreprises.inpi.fr/api/companies`
- **Authentification** : Bearer Token (g√©n√©r√© automatiquement)
- **Utilisation** : Recherche des SCI par code postal

#### **La Poste**
- **URL API** : `https://api.servicepostal.com/lettres` (production)
- **URL Sandbox** : `https://sandbox-api.servicepostal.com/lettres`
- **Authentification** : Cl√© API
- **Utilisation** : Envoi de lettres recommand√©es

### **üìÆ Param√®tres d'envoi La Poste**

| Param√®tre | Options | D√©faut | Description |
|-----------|---------|---------|-------------|
| **Type d'affranchissement** | lrar, lr, prioritaire, suivi, verte, etc. | `lrar` | D√©termine le service postal |
| **Taille d'enveloppe** | auto, c4, c5, c6 | `auto` | Format de l'enveloppe |
| **Type d'enveloppe** | fenetre, imprime | `fenetre` | Enveloppe √† fen√™tre ou imprim√©e |
| **Couleur** | nb, couleur | `nb` | Impression noir/blanc ou couleur |
| **Recto-verso** | recto, rectoverso | `rectoverso` | Mode d'impression |

### **üë§ Configuration utilisateur**

Le plugin r√©cup√®re automatiquement les donn√©es exp√©diteur depuis :
1. **Champs ACF** (priorit√©) : `prenom_user`, `nom_user`, `adresse_user`, etc.
2. **WooCommerce** : `billing_first_name`, `billing_address_1`, etc.
3. **WordPress** : `first_name`, `last_name`, etc.

## üìñ Utilisation

### **1. Recherche de SCI**
1. Aller dans **SCI** dans l'admin WordPress
2. S√©lectionner un code postal (configur√© dans votre profil ACF)
3. Cliquer sur "üîç Rechercher les SCI"
4. Consulter les r√©sultats dans le tableau

### **2. Gestion des favoris**
- Cliquer sur l'‚≠ê pour ajouter/retirer des favoris
- Consulter vos favoris dans **SCI > Mes Favoris**

### **3. Cr√©ation d'une campagne**
1. S√©lectionner les SCI avec les checkboxes
2. Cliquer sur "üì¨ Cr√©er une campagne"
3. R√©diger le titre et contenu de votre lettre
4. V√©rifier le r√©capitulatif
5. Proc√©der au paiement (si WooCommerce activ√©)
6. Les lettres sont envoy√©es automatiquement

### **4. Suivi des campagnes**
- Consulter l'historique dans **SCI > Mes Campagnes**
- Voir le d√©tail de chaque envoi avec les UID de tracking
- Consulter les logs d'API dans **SCI > Logs API**

## üìù Shortcodes

### **[sci_panel]**
Affiche le panneau de recherche complet avec toutes les fonctionnalit√©s.

```php
// Usage simple
[sci_panel]

// Avec param√®tres (optionnel)
[sci_panel codes_postaux="75001,75002" theme="dark"]
```

### **[sci_favoris]**
Affiche la liste des SCI favorites de l'utilisateur connect√©.

```php
[sci_favoris]
```

### **[sci_campaigns]**
Affiche l'historique des campagnes de l'utilisateur connect√©.

```php
[sci_campaigns]
```

### **Configuration des URLs**
Dans **SCI > Configuration**, configurez les URLs de vos pages contenant les shortcodes pour les redirections automatiques.

## üîß APIs utilis√©es

### **üèõÔ∏è API INPI**
- **Endpoint** : `/api/companies`
- **M√©thode** : GET
- **Param√®tres** : `companyName=SCI&zipCodes[]=75001&pageSize=100`
- **Authentification** : Bearer Token (auto-g√©n√©r√©)
- **Rate limiting** : Respect√© automatiquement

### **üìÆ API La Poste**
- **Endpoint** : `/lettres`
- **M√©thode** : POST
- **Format** : JSON avec PDF en base64
- **Authentification** : Cl√© API dans les headers
- **Services** : LRAR, LR, Prioritaire, Suivi, etc.

## üìÅ Structure du plugin

```
my-istymo-sci-plugin/
‚îú‚îÄ‚îÄ üìÑ my-istymo-sci-plugin.php     # Fichier principal
‚îú‚îÄ‚îÄ üìÑ popup-lettre.php             # Gestion des popups
‚îú‚îÄ‚îÄ üìÑ README.md                    # Documentation
‚îú‚îÄ‚îÄ üìÑ CHANGELOG.md                 # Historique des versions
‚îú‚îÄ‚îÄ üìÅ assets/
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ css/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ üìÑ style.css            # Styles du plugin
‚îÇ   ‚îî‚îÄ‚îÄ üìÅ js/
‚îÇ       ‚îú‚îÄ‚îÄ üìÑ favoris.js           # Gestion des favoris
‚îÇ       ‚îú‚îÄ‚îÄ üìÑ lettre.js            # Interface des lettres
‚îÇ       ‚îî‚îÄ‚îÄ üìÑ payment.js           # Syst√®me de paiement
‚îú‚îÄ‚îÄ üìÅ includes/
‚îÇ   ‚îú‚îÄ‚îÄ üìÑ campaign-manager.php     # Gestionnaire de campagnes
‚îÇ   ‚îú‚îÄ‚îÄ üìÑ config-manager.php       # Configuration s√©curis√©e
‚îÇ   ‚îú‚îÄ‚îÄ üìÑ favoris-handler.php      # Gestion des favoris
‚îÇ   ‚îú‚îÄ‚îÄ üìÑ inpi-token-manager.php   # Tokens INPI automatiques
‚îÇ   ‚îú‚îÄ‚îÄ üìÑ shortcodes.php           # Shortcodes frontend
‚îÇ   ‚îî‚îÄ‚îÄ üìÑ woocommerce-integration.php # Int√©gration WooCommerce
‚îî‚îÄ‚îÄ üìÅ lib/
    ‚îî‚îÄ‚îÄ üìÅ tcpdf/                   # Biblioth√®que PDF
```

## üóÉÔ∏è Base de donn√©es

### **Tables cr√©√©es**
- `wp_sci_favoris` - Stockage des favoris utilisateur
- `wp_sci_campaigns` - Campagnes de lettres
- `wp_sci_campaign_letters` - D√©tail des envois
- `wp_sci_inpi_credentials` - Historique des tokens INPI

### **M√©tadonn√©es WooCommerce**
- `_sci_campaign_data` - Donn√©es de la campagne
- `_sci_campaign_status` - Statut du traitement
- `_sci_campaign_id` - ID de la campagne li√©e

## üîí S√©curit√©

### **Authentification**
- Tokens stock√©s de mani√®re chiffr√©e
- Nonces WordPress pour toutes les requ√™tes AJAX
- V√©rification des permissions utilisateur

### **Validation des donn√©es**
- Sanitisation de tous les inputs
- Validation des formats (SIREN, codes postaux, etc.)
- Protection contre les injections SQL

### **APIs externes**
- Gestion des erreurs et timeouts
- Retry automatique en cas d'√©chec
- Logs d√©taill√©s pour le debugging

## üìä Logs et debugging

### **Fichiers de logs**
- **Emplacement** : `/wp-content/uploads/lettre-laposte/logs.txt`
- **Contenu** : Requ√™tes API, r√©ponses, erreurs
- **Rotation** : Manuelle via l'interface admin

### **Consultation des logs**
1. Aller dans **SCI > Logs API**
2. Consulter les 100 derni√®res entr√©es
3. Analyser les codes de r√©ponse et messages d'erreur

## üîÑ Changelog

### **Version 1.6 (Actuelle)**
- ‚úÖ Int√©gration WooCommerce compl√®te
- ‚úÖ Syst√®me de paiement embarqu√©
- ‚úÖ Gestion automatique des tokens INPI
- ‚úÖ Shortcodes frontend
- ‚úÖ Interface responsive am√©lior√©e
- ‚úÖ Logs API d√©taill√©s

### **Version 1.5**
- ‚úÖ Gestionnaire de campagnes
- ‚úÖ Configuration s√©curis√©e des APIs
- ‚úÖ Syst√®me de favoris en BDD
- ‚úÖ G√©n√©ration PDF avec TCPDF

### **Version 1.4**
- ‚úÖ Int√©gration API La Poste
- ‚úÖ Interface de recherche SCI
- ‚úÖ Gestion des favoris localStorage

## üÜò Support et d√©pannage

### **Probl√®mes courants**

#### **‚ùå "Token INPI non configur√©"**
**Solution** : Aller dans **SCI > Identifiants INPI** et configurer vos identifiants de connexion.

#### **‚ùå "Erreur API La Poste"**
**Solutions** :
1. V√©rifier la cl√© API dans **SCI > Configuration**
2. Consulter les logs dans **SCI > Logs API**
3. V√©rifier que l'URL API est correcte (sandbox vs production)

#### **‚ùå "Donn√©es exp√©diteur incompl√®tes"**
**Solution** : Compl√©ter votre profil utilisateur avec les champs ACF ou WooCommerce requis.

#### **‚ùå "WooCommerce requis"**
**Solution** : Installer WooCommerce ou utiliser le mode envoi direct (sans paiement).

### **Debugging**
1. Activer `WP_DEBUG` dans `wp-config.php`
2. Consulter les logs dans **SCI > Logs API**
3. V√©rifier les erreurs PHP dans `/wp-content/debug.log`

### **Performance**
- **Cache** : Les tokens INPI sont mis en cache 24h
- **Optimisation** : Pagination automatique des r√©sultats
- **Timeout** : 30 secondes pour les requ√™tes API

## üë®‚Äçüíª D√©veloppement

### **Hooks disponibles**
```php
// Avant envoi d'une lettre
do_action('sci_before_send_letter', $entry, $campaign_data);

// Apr√®s envoi r√©ussi
do_action('sci_after_send_letter', $entry, $response);

// Erreur d'envoi
do_action('sci_send_letter_error', $entry, $error);
```

### **Filtres disponibles**
```php
// Modifier le contenu de la lettre
$content = apply_filters('sci_letter_content', $content, $entry);

// Modifier les param√®tres La Poste
$params = apply_filters('sci_laposte_params', $params, $entry);
```

## üìû Contact

- **Auteur** : Brio Guiseppe
- **Version** : 1.6
- **Licence** : GPL v2 ou ult√©rieure
- **Support** : Via l'interface d'administration WordPress

---

## üéØ Roadmap

### **Version 1.7 (Pr√©vue)**
- [ ] Interface de statistiques avanc√©es
- [ ] Export des campagnes en CSV/Excel
- [ ] Templates de lettres pr√©d√©finis
- [ ] Int√©gration avec d'autres APIs immobili√®res

### **Version 1.8 (Pr√©vue)**
- [ ] Mode multi-utilisateur avec permissions
- [ ] API REST pour int√©grations tierces
- [ ] Webhook pour notifications en temps r√©el
- [ ] Interface mobile d√©di√©e

---

**üöÄ Plugin SCI - Simplifiez vos d√©marches de prospection immobili√®re !**